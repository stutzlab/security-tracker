--TODO IMPROVE TEST REPEATINESS (essa palavra existe? hehe)
local storageutils = dofile("util-storage.lua");

--cleanup previous test files
local fc = file.list();
for n in pairs(fc) do
    if(string.sub(n, 1, 6) == "12TEST") then
        print("Removing previous test file " .. n);
        file.remove(n);
    end
end

local remaining = file.fsinfo();
local lastRemaining = remaining;
print("Starting storageutils tests. remaining=" .. remaining);


--500bytes
file.open("12TEST1", "w+");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.close();

local r = storageutils.freeupStorage(remaining-300, remaining-300, "12TEST");
assert(r);
assert(file.fsinfo()==remaining);

--500bytes
file.open("12TEST2", "w+");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.close();
lastRemaining = file.fsinfo();
--print("Test1 used=".. (remaining - lastRemaining));

local r = storageutils.freeupStorage(lastRemaining-10, lastRemaining-10, "12TEST");
assert(not r);
assert(file.fsinfo()==lastRemaining);


--500bytes
file.open("12TEST3", "w+");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.close();
lastRemaining = file.fsinfo();
print("Test2 used=".. (remaining - lastRemaining));

local r = storageutils.freeupStorage(lastRemaining-10, lastRemaining-10, "12TEST");
assert(not r);
assert(file.fsinfo()==lastRemaining);


--500bytes
file.open("12TEST4", "w+");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.close();
lastRemaining = file.fsinfo();
--print("Test3 used=".. (remaining - lastRemaining));

local r = storageutils.freeupStorage(lastRemaining-10, lastRemaining-10, "12TEST");
assert(not r);
assert(file.fsinfo()==lastRemaining);


--500bytes
file.open("12TEST5", "w+");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.write("0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789");
file.close();
lastRemaining = file.fsinfo();
--print("Test4 used=".. (remaining - lastRemaining));

local r = storageutils.freeupStorage(lastRemaining+500, lastRemaining+1200, "12TEST");
assert(r);
assert(file.fsinfo()>=lastRemaining+1200);

local fc = file.list();
local found4 = false;
local found5 = false;
for n in pairs(fc) do
    if(string.sub(n, 1, 6) == "12TEST") then
        assert(n ~= "12TEST1");
        assert(n ~= "12TEST2");
        assert(n ~= "12TEST3");
        if(n == "12TEST4") then
            found4 = true;
        elseif(n == "12TEST5") then
            found5 = true;
        end        
    end
end
assert(found4);
assert(found5);

--cleanup all
local r = storageutils.freeupStorage(remaining, remaining, "12TEST");
assert(r);
assert(file.fsinfo()==remaining);

print("ALL TESTS PASSED: util-storage");

return true;
